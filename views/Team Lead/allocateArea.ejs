<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Assign Area</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/bbbootstrap/libraries@main/choices.min.css"
    />
    <script src="https://cdn.jsdelivr.net/gh/bbbootstrap/libraries@main/choices.min.js"></script>

    <!--===============================================================================================-->
    <link
      rel="stylesheet"
      type="text/css"
      href="<%=url%>/vendor/bootstrap/css/bootstrap.min.css"
    />
    <!--===============================================================================================-->
    <link
      rel="stylesheet"
      type="text/css"
      href="<%=url%>/fonts-1/font-awesome-4.7.0/css/font-awesome.css"
    />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="<%=url%>/css/main.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="<%=url%>/css/style_2.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="<%=url%>/toastr/toastr.min.css"
    />
    <!--===============================================================================================-->
  </head>

  <body>
    <div class="limiter">
      <div class="container-profile100">
        <div class="header">
          <div class="cover-image100">
            <img src="<%=url%>/logo/logo.png" class="pep-logo" alt="" />
            <a href="#">
              <span class="fa fa-bars menu-button" onclick="openMenu()"></span>
            </a>
            <a href="<%=url%>/teamlead/notification">
              <span class="fa fa-bell menu-button">
                <span class="button__badge" style="display: none"></span>
              </span>
            </a>
            <nav id="menu">
              <ul>
                <% permissions.forEach(element=> { %>
                <li>
                  <a
                    href="<%=url%>/teamlead<%= element.controller%>/<%=info.uuid%>"
                  >
                    <span class="<%= element.icon%>"></span>
                    <%= element.permission_name %>
                  </a>
                </li>
                <% }); %>
                <li>
                  <a href="<%=url%>/teamlead/signout">
                    <span class="fa fa-sign-out"> </span> Log Out</a
                  >
                </li>
              </ul>
              <span class="fa fa-times close-menu" onclick="closeMenu()"></span>
            </nav>
          </div>
          <!-- --------------------- -->
          <div class="container saleup">
            <h3 class="text-center mb-2">Allot Area to Employees</h3>

            <div class="container p-2 mt-4">
              <div class="row">
                <div class="col-sm-3">
                  <h6 class="mt-3">Area</h6>
                </div>
                <div class="col-sm-6 mb-2">
                  <select
                    id="area"
                    class="area w-100 h-100 p-2"
                    placeholder="Select Area"
                  >
                    <%areaSectors.forEach(area =>{ %>
                    <option value="<%=area.city_sector_uuid%>">
                      <%= area.sector_name %>
                    </option>
                    <% }) %>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="col-sm-3">
                  <h6 class="mt-3">Select Employees</h6>
                </div>
                <div class="col-sm-6">
                  <select
                    id="employees"
                    placeholder="Select Employees"
                    multiple="multiple"
                  >
                    <%allTeamMember.forEach(area =>{ %>
                    <option value="<%=area.field_uuid%>">
                      <%= area.field_name %>
                    </option>
                    <% }) %>
                  </select>
                </div>
                <div class="col-12">
                  <input
                    type="submit"
                    value="Allot Area"
                    class="w-25 allot_btn"
                    id="allotarea"
                  />
                </div>
              </div>
            </div>
          </div>
          <div class="container mt-5">
            <% if(!teamMember) { %>
            <div class="text-center p-3 text-danger mt-5">
              <h5>You don't have any Team.</h5>
              <h5>Please build a team first.</h5>
            </div>
            <% }else{ %>

            <table class="table" id="areaTable">
              <thead class="thead-light">
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Name</th>
                  <th scope="col">Contact</th>
                  <th scope="col">Current Area</th>
                </tr>
              </thead>
              <tbody>
                <% allTeamMember.forEach((element,index) => { %>
                <tr>
                  <td scope="col"><strong> <%= ++index %> </strong></td>
                  <td scope="col"><%=element.field_name %></td>
                  <td scope="col"><%=element.field_contact %></td>

                  <td scope="col">
                    <% teamMember.forEach(member => { %>
                    <%if(element.field_uuid=== member.field_uuid ){%>
                    <ul class="list-group">
                      <%member.City_Sectors.forEach(area => {%>
                      <li
                        class="
                          list-group-item
                          d-flex
                          justify-content-between
                          align-items-center
                        "
                      >
                        <%=area.sector_name %>
                        <span
                          class="badge badge-danger badge-pill"
                          style="cursor: pointer"
                          onclick="deleteArea('<%=area.city_sector_uuid%>','<%=member.field_uuid%>')"
                        >
                          <i class="fa fa-times" aria-hidden="true"></i
                        ></span>
                      </li>

                      <% }) %>
                    </ul>

                    <%} })%>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
            <%} %>
          </div>
          <!-- ---------------- -->
        </div>
      </div>
    </div>

    <!--===============================================================================================-->
    <script src="<%=url%>/js/jquery.min.js"></script>
    <script src="<%=url%>/bootstrap/js/bootstrap.min.js"></script>
    <!-- Toastr -->
    <!--===============================================================================================-->
    <script src="<%=url%>/vendor/jquery/tilt.jquery.min.js"></script>
    <script src="<%=url%>/toastr/toastr.min.js"></script>
    <script>
      var notificationCount = JSON.parse(
        "<%-JSON.stringify(unreadNotificationCount)%>"
      );
      if (notificationCount) {
        $(".button__badge").css("display", "block");
        $(".button__badge").html(
          JSON.parse("<%-JSON.stringify(unreadNotificationCount)%>")
        );
      }

      function pagination() {
        //   $('#data').after('<div id="nav" class="text-center"></div>');
        var rowsShown = 10;
        var rowsTotal = $("#areaTable tbody tr").length;
        if (rowsShown < rowsTotal) {
          $("#areaTable").after('<div id="nav" class="text-center" ></div>');
          var numPages = rowsTotal / rowsShown;
          for (i = 0; i < numPages; i++) {
            var pageNum = i + 1;
            $("#nav").append(
              '<a href="#" rel="' + i + '">' + pageNum + "</a> "
            );
          }
          $("#areaTable tbody tr").hide();
          $("#areaTable tbody tr").slice(0, rowsShown).show();
          $("#nav a").bind("click", function () {
            var currPage = $(this).attr("rel");
            var startItem = currPage * rowsShown;
            var endItem = startItem + rowsShown;
            $("#areaTable tbody tr")
              .css("opacity", "0.0")
              .hide()
              .slice(startItem, endItem)
              .css("display", "table-row")
              .animate(
                {
                  opacity: 1,
                },
                300
              );
          });
        }
      }

      window.onload = () => {
        pagination();
      };

      $(".js-tilt").tilt({
        scale: 1.1,
      });

      const deleteArea = (selectedArea, executiveUUID) => {
        $.ajax({
          type: "PUT",
          url: `${window.location.origin}/teamlead/removeSectorToExecutive`,
          data: { selectedArea, executiveUUID },
          dataType: "json",
          error: (error) => {
            console.error(error);
            toastr.error(error.error);
          },
          success: (response) => {
            if (response.executiveID[0]) toastr.success(response.message);
            else toastr.warning("Sector is already marked deleted");
          },
        });
      };

      var menu = document.getElementById("menu"),
        teamMember = JSON.parse(`<%-JSON.stringify(teamMember)%>`),
        allTeamMember = JSON.parse(`<%-JSON.stringify(allTeamMember)%>`);
      function openMenu() {
        menu.style.top = "0";
      }
      function closeMenu() {
        menu.style.top = "-100vh";
      }
      $(document).ready(function () {
        var multipleCancelButton = new Choices("#employees", {
          removeItemButton: true,
        });
      });

      //function to check if the user is already have the same area then prevent it

      const checkUserArea = (dbData, selectedArea, employeeUUID) => {
        var employeesSelected = [],
          status = false;
        for (const iteratorEmployee of employeeUUID) {
          for (const data of dbData) {
            if (data.field_uuid === iteratorEmployee) {
              for (const dataArea of data.City_Sectors) {
                if (selectedArea === dataArea.city_sector_uuid) {
                  status = true;
                }
              }
            }
          }
        }
        return status;
      };

      $("#allotarea").click(() => {
        var selectedArea = document.getElementById("area").value,
          employees = [];

        $("#employees option ").each(function () {
          var thisOptionValue = $(this).val();
          employees.push(thisOptionValue);
        });

        let checkUserExists = false;
        if (employees.length > 0)
          checkUserExists = checkUserArea(teamMember, selectedArea, employees);
        else {
          toastr.error("Please select employee");
          return;
        }
        if (checkUserExists) {
          toastr.error("Sector is already allot to the user.");
          return;
        } else {
          console.log(selectedArea, employees);
          $.ajax({
            type: "POST",
            url: `${window.location.origin}/allocateSectorToExecutive`,
            data: { selectedArea, employees: JSON.stringify(employees) },
            dataType: "json",
            error: (error) => {
              if (error) {
                console.error(error);
                toastr.error("There is an error while Allocating Area");
              }
            },
            success: (response) => {
              if (response) {
                console.log(response);
                toastr.success("Area Allocated to the Employees ");
                location.reload(true);
              }
            },
          });
        }
      });
    </script>
  </body>
</html>
